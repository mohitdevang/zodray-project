<?xml version="1.0" encoding="utf-8"?>
<configuration>
  <system.webServer>
    <!-- 
      CRITICAL: Pass through HTTP errors to Laravel instead of showing IIS error pages.
      This ensures API routes return JSON instead of HTML error pages.
      Without this, IIS will show HTML 401/500 pages even for public routes like /api/register.
    -->
    <httpErrors existingResponse="PassThrough" errorMode="Detailed" />
    
    <!-- 
      Ensure all requests are processed by Laravel, not blocked by IIS.
      This allows Laravel to handle authentication logic for API routes.
    -->
    <modules runAllManagedModulesForAllRequests="true" />

    <!-- 
      URL Rewriting for Laravel - all requests go through index.php
      This ensures Laravel handles routing and can return JSON responses.
    -->
    <rewrite>
      <rules>
        <!-- Laravel URL Rewriting -->
        <rule name="Laravel" stopProcessing="true">
          <match url=".*" ignoreCase="false" />
          <conditions logicalGrouping="MatchAll">
            <add input="{REQUEST_FILENAME}" matchType="IsFile" negate="true" />
            <add input="{REQUEST_FILENAME}" matchType="IsDirectory" negate="true" />
          </conditions>
          <action type="Rewrite" url="index.php" />
        </rule>
      </rules>
    </rewrite>

    <!-- 
      Note: IIS Basic Auth may be enforced at the server level.
      The key is that we pass through errors so Laravel can return JSON.
      Our middleware (CheckSanctumToken) handles the dual authentication.
      
      IMPORTANT: For public routes like /api/register and /api/login:
      - IIS Basic Auth credentials MUST be valid for the request to reach Laravel
      - Once the request reaches Laravel, it will return JSON (not HTML)
      - Laravel will handle the actual authentication logic
    -->

    <!-- 
      Default files - Laravel handles routing through index.php
    -->
    <defaultDocument>
      <files>
        <clear />
        <add value="index.php" />
      </files>
    </defaultDocument>

    <!-- 
      Directory browsing disabled for security
    -->
    <directoryBrowse enabled="false" />

    <!-- 
      PHP settings - ensure proper error handling
    -->
    <httpProtocol>
      <customHeaders>
        <remove name="X-Powered-By" />
      </customHeaders>
    </httpProtocol>
  </system.webServer>
</configuration>
